{"version":3,"sources":["api/qrcode/qrcode.controller.js"],"names":["_","require","config","exports","index","req","res","json","qrcode","QRCode","toDataURL","params","id","err","src","render","gift_get","next","request","hostname","host","split","shift","options","url","api","uri","headers","component","error","response","body","console","log","send","statusCode","message","errmsg","order","gift_qrcode"],"mappings":"AAAA;;AAEA,IAAIA,IAAIC,QAAQ,QAAR,CAAR;AACA,IAAIC,SAASD,QAAQ,0BAAR,CAAb;;AAEA;AACAE,QAAQC,KAAR,GAAgB,UAASC,GAAT,EAAcC,GAAd,EAAmB;AACjCA,MAAIC,IAAJ,CAAS,EAAT;AACD,CAFD;;AAIAJ,QAAQK,MAAR,GAAiB,UAASH,GAAT,EAAcC,GAAd,EAAmB;AAClC,MAAIG,SAASR,QAAQ,QAAR,CAAb;AACAQ,SAAOC,SAAP,CAAiBL,IAAIM,MAAJ,CAAWC,EAA5B,EAA+B,UAASC,GAAT,EAAaC,GAAb,EAAiB;AAC9CR,QAAIS,MAAJ,CAAW,QAAX,EAAoB,EAACD,KAAIA,GAAL,EAApB;AACD,GAFD;AAGD,CALD;;AAOAX,QAAQa,QAAR,GAAmB,UAASX,GAAT,EAAaC,GAAb,EAAiBW,IAAjB,EAAsB;AACvC,MAAIC,UAAUjB,QAAQ,SAAR,CAAd;AACA;AACA,MAAIkB,WAAWd,IAAIe,IAAJ,CAASC,KAAT,CAAe,GAAf,EAAoBC,KAApB,EAAf;AACA,MAAIC,UAAU;AACZC,SAAKtB,OAAOuB,GAAP,CAAWC,GAAX,GAAe,cAAf,GAA8BrB,IAAIM,MAAJ,CAAWC,EADlC;AAEZe,aAAS;AACP,oBAAa,QADN;AAEP,iBAAUR,QAFH;AAGP,qBAAcjB,OAAOuB,GAAP,CAAWG;AAHlB,KAFG;AAOZrB,UAAK;AAPO,GAAd;AASAW,UAAQK,OAAR,EAAiB,UAAUM,KAAV,EAAiBC,QAAjB,EAA2BC,IAA3B,EAAiC;AAChD,QAAGF,KAAH,EAAS;AACPG,cAAQC,GAAR,CAAYJ,KAAZ;AACAvB,UAAI4B,IAAJ,CAAS,OAAT;AACA;AACD;AACD,QAAGJ,SAASK,UAAT,KAAwB,GAA3B,EAA+B;AAC7B,UAAIC,UAAUL,KAAKM,MAAL,GAAYN,KAAKM,MAAjB,GAAwB,OAAtC;AACA/B,UAAI4B,IAAJ,CAASE,OAAT;AACA;AACD;AACD,QAAI,CAACP,KAAD,IAAUC,SAASK,UAAT,IAAuB,GAArC,EAA0C;AACxC9B,UAAIiC,KAAJ,GAAYP,IAAZ;AACAd;AACD;AACF,GAfD;AAgBD,CA7BD;AA8BAd,QAAQoC,WAAR,GAAsB,UAASlC,GAAT,EAAcC,GAAd,EAAmB;AACvC,MAAIkB,MAAM,YAAUnB,IAAIe,IAAd,GAAmB,eAAnB,GAAmCf,IAAIiC,KAAJ,CAAU1B,EAAvD;AACA,MAAIH,SAASR,QAAQ,QAAR,CAAb;AACAQ,SAAOC,SAAP,CAAiBc,GAAjB,EAAqB,UAASX,GAAT,EAAaC,GAAb,EAAiB;AACpCR,QAAIS,MAAJ,CAAW,aAAX,EAAyB,EAACD,KAAIA,GAAL,EAASwB,OAAMjC,IAAIiC,KAAnB,EAAzB;AACD,GAFD;AAGD,CAND","file":"api/qrcode/qrcode.controller.js","sourcesContent":["'use strict';\n\nvar _ = require('lodash');\nvar config = require('../../config/environment');\n\n// Get list of qrcodes\nexports.index = function(req, res) {\n  res.json([]);\n};\n\nexports.qrcode = function(req, res) {\n  var QRCode = require('qrcode');\n  QRCode.toDataURL(req.params.id,function(err,src){\n    res.render('qrcode',{src:src});\n  });\n};\n\nexports.gift_get = function(req,res,next){\n  var request = require('request');\n  //require('request').debug = true;\n  var hostname = req.host.split('.').shift();\n  var options = {\n    url: config.api.uri+'/gift/order/'+req.params.id,\n    headers: {\n      'X-API-From':'client',\n      'X-APPID':hostname,\n      'X-Component':config.api.component\n    },\n    json:true\n  };\n  request(options, function (error, response, body) {\n    if(error){\n      console.log(error);\n      res.send('系统错误！');\n      return;\n    }\n    if(response.statusCode !== 200){\n      var message = body.errmsg?body.errmsg:'系统错误！';\n      res.send(message);\n      return;\n    }\n    if (!error && response.statusCode == 200) {\n      req.order = body;\n      next();\n    }\n  });\n};\nexports.gift_qrcode = function(req, res) {\n  var url = 'http://'+req.host+'/gift/listen/'+req.order.id;\n  var QRCode = require('qrcode');\n  QRCode.toDataURL(url,function(err,src){\n    res.render('qrcode_gift',{src:src,order:req.order});\n  });\n};\n"],"sourceRoot":"/source/"}